<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapporo 2026 | Pro Travel Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .day-card.active { background: #2D3436; color: white; transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        .img-gradient { background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.8)); }
        
        #loading-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.85); 
            z-index: 10000; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: white; 
        }
    </style>
</head>
<body class="bg-[#F8F9FA] text-[#2D3436] pb-24">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mb-4"></div>
        <p class="font-black text-sm tracking-widest text-center px-6">壓縮引擎優化中...<br><span class="text-[10px] opacity-60">正在為您的儲存空間減負</span></p>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="global-img-input" class="hidden" accept="image/*">
    <input type="file" id="lib-file-input" class="hidden" accept="application/pdf,image/*">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass border-b border-gray-100 p-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-[#0984e3] to-[#74b9ff] rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-snowflake"></i>
            </div>
            <div>
                <h1 class="text-sm font-black tracking-tight leading-none mb-1">Sapporo 2026</h1>
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                    <i class="fas fa-shield-alt text-blue-400"></i> Optimized Storage
                </p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="resetData()" class="px-2 py-2 text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
            <button id="edit-btn" onclick="toggleEdit()" class="px-4 py-2 bg-[#2D3436] text-white rounded-xl font-black text-[11px] shadow-md flex items-center gap-2">
                <i class="fas fa-edit"></i> <span>編輯模式</span>
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <nav class="flex px-6 pt-4 gap-8 border-b border-gray-100 bg-white sticky top-[73px] z-40">
        <button onclick="switchTab('itinerary')" id="tab-itinerary" class="pb-3 text-[10px] font-black uppercase tracking-widest relative text-[#2D3436]">
            行程導航
            <div id="ind-itinerary" class="absolute bottom-0 left-0 right-0 h-1 bg-[#0984e3] rounded-full"></div>
        </button>
        <button onclick="switchTab('tools')" id="tab-tools" class="pb-3 text-[10px] font-black uppercase tracking-widest relative text-gray-300">
            清單與文件
            <div id="ind-tools" class="hidden absolute bottom-0 left-0 right-0 h-1 bg-[#0984e3] rounded-full"></div>
        </button>
    </nav>

    <main class="p-4 max-w-2xl mx-auto space-y-6">
        
        <!-- Itinerary Tab -->
        <section id="content-itinerary" class="space-y-6">
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[9px] font-black text-gray-400 uppercase">札幌即時天氣</p>
                        <p id="weather-display" class="text-sm font-black">載入中...</p>
                    </div>
                    <div id="weather-icon"><i class="fas fa-snowflake text-blue-100"></i></div>
                </div>
                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm">
                    <p class="text-[9px] font-black text-gray-400 uppercase mb-2">匯率 (JPY to HKD)</p>
                    <div class="flex gap-2">
                        <input type="number" id="jpy-input" oninput="convertCurrency('jpy')" placeholder="¥" class="w-full bg-gray-50 rounded-lg p-1 text-xs font-black outline-none">
                        <input type="number" id="hkd-input" oninput="convertCurrency('hkd')" placeholder="$" class="w-full bg-blue-50/50 rounded-lg p-1 text-xs font-black outline-none text-blue-600">
                    </div>
                </div>
            </div>

            <!-- Day Selector -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar py-2" id="day-selector"></div>

            <!-- Main Day View -->
            <div id="day-details" class="bg-white rounded-[2.5rem] overflow-hidden shadow-xl border border-gray-100">
                <div id="day-banner" class="h-48 relative bg-gray-200">
                    <img id="day-img" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 img-gradient"></div>
                    <button id="banner-upload-btn" onclick="triggerImgUpload('banner')" class="hidden absolute top-4 right-4 w-10 h-10 bg-white/20 backdrop-blur-md border border-white/30 rounded-full text-white flex items-center justify-center"><i class="fas fa-camera"></i></button>

                    <div class="absolute bottom-6 left-8 right-8 flex justify-between items-end text-white">
                        <div>
                            <span id="day-label" class="inline-block px-3 py-0.5 bg-blue-500 rounded-full text-[9px] font-black uppercase mb-2">Day 1</span>
                            <div id="day-title-container"></div>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold opacity-70">今日預算總額</p>
                            <p id="day-budget" class="text-lg font-black">¥ 0</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-8">
                    <div id="timeline" class="space-y-10 relative"></div>
                    <div id="add-event-container" class="hidden mt-10">
                        <button onclick="addEvent()" class="w-full py-4 border-2 border-dashed border-gray-200 rounded-3xl text-gray-400 font-black text-xs">
                            <i class="fas fa-plus mr-2"></i> 新增行程項目
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tools Tab -->
        <section id="content-tools" class="hidden space-y-6">
            <!-- Quick Links -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black tracking-tight flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500"><i class="fas fa-link text-sm"></i></span>
                        導航連結
                    </h2>
                    <button id="add-link-btn" onclick="addLink()" class="hidden px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-[10px] font-black">新增</button>
                </div>
                <div id="link-list" class="space-y-3"></div>
            </div>

            <!-- Documents -->
            <div class="bg-[#2D3436] p-6 rounded-[2.5rem] shadow-xl text-white">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black tracking-tight flex items-center gap-3">
                        <span class="w-8 h-8 bg-white/10 rounded-xl flex items-center justify-center text-red-400"><i class="fas fa-file-pdf text-sm"></i></span>
                        文件圖庫 (PDF/圖)
                    </h2>
                    <button id="add-doc-btn" onclick="document.getElementById('lib-file-input').click()" class="hidden px-4 py-2 bg-white/10 text-white rounded-xl text-[10px] font-black border border-white/20">上傳檔案</button>
                </div>
                <div id="document-list" class="space-y-3"></div>
            </div>

            <!-- Checklist -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <h2 class="text-xl font-black tracking-tight mb-6 flex items-center gap-3">
                    <span class="w-8 h-8 bg-orange-50 rounded-xl flex items-center justify-center text-orange-500"><i class="fas fa-check-double text-sm"></i></span>
                    出發準備
                </h2>
                <div id="checklist" class="space-y-3"></div>
            </div>

            <!-- Memories -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black tracking-tight flex items-center gap-3">
                        <span class="w-8 h-8 bg-purple-50 rounded-xl flex items-center justify-center text-purple-500"><i class="fas fa-camera-retro text-sm"></i></span>
                        旅程剪影
                    </h2>
                    <button id="add-photo-btn" onclick="triggerImgUpload('gallery')" class="hidden px-4 py-2 bg-purple-50 text-purple-600 rounded-xl text-[10px] font-black">相機上傳</button>
                </div>
                <div id="photo-gallery" class="grid grid-cols-2 gap-3"></div>
            </div>
        </section>
    </main>

    <script>
        const STORE_KEY = 'SAPPORO_V7_FINAL';
        const exchangeRate = 0.052;
        let currentDayIdx = 0;
        let isEditing = false;
        let uploadMeta = null;

        const defaultData = {
            itinerary: [
                { 
                    date: "2/16", weekday: "MON", title: "抵達札幌 · 壽司之夜", 
                    img: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=1000",
                    events: [
                        { timeFrom: "15:00", loc: "新千歲機場", desc: "抵達後提取行李，搭乘 JR 快速 Airport 號往札幌站。", icon: "fa-plane-arrival", color: "text-blue-500", cost: 1150, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=New+Chitose+Airport" },
                        { timeFrom: "20:30", loc: "鮨 棗 (Sushi Natsume)", desc: "預約在 Akarenga Terrace 3F。", icon: "fa-utensils", color: "text-rose-500", cost: 15000, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=鮨+棗+Akarenga+Terrace" }
                    ]
                },
                { 
                    date: "2/17", weekday: "TUE", title: "音樂決賽日 @ Sun Plaza", 
                    img: "https://images.unsplash.com/photo-1520527057854-1539d2200213?w=1000",
                    events: [
                        { timeFrom: "10:00", loc: "Sapporo Sun Plaza", desc: "舞台試琴與音樂決賽。", icon: "fa-music", color: "text-purple-500", cost: 250, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Sapporo+Sun+Plaza" },
                        { timeFrom: "18:00", loc: "北海道大學", desc: "賽後散步欣賞雪景。", icon: "fa-camera", color: "text-emerald-500", cost: 0, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Hokkaido+University" }
                    ]
                },
                { 
                    date: "2/18", weekday: "WED", title: "小樽浪漫一日遊", 
                    img: "https://images.unsplash.com/photo-1578335345700-112347b59e61?w=1000",
                    events: [
                        { timeFrom: "11:00", loc: "小樽運河", desc: "散步、拍夜景與逛音樂盒堂。", icon: "fa-anchor", color: "text-blue-400", cost: 2000, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Otaru+Canal" },
                        { timeFrom: "15:00", loc: "小樽音樂盒堂", desc: "挑選紀念品。", icon: "fa-shopping-bag", color: "text-amber-500", cost: 3000, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Otaru+Music+Box+Museum" }
                    ]
                },
                { 
                    date: "2/19", weekday: "THU", title: "滑雪體驗日", 
                    img: "https://images.unsplash.com/photo-1486944670663-e0a2ea5018ef?w=1000",
                    events: [
                        { timeFrom: "09:00", loc: "札幌國際滑雪場", desc: "全日滑雪與雪地活動。", icon: "fa-snowflake", color: "text-cyan-500", cost: 8500, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Sapporo+Kokusai+Ski+Resort" }
                    ]
                },
                { 
                    date: "2/20", weekday: "FRI", title: "頒獎禮 @ Kitara", 
                    img: "https://images.unsplash.com/photo-1514320298543-efb551730969?w=1000",
                    events: [
                        { timeFrom: "14:00", loc: "札幌音樂廳 Kitara", desc: "參加頒獎典禮。", icon: "fa-trophy", color: "text-yellow-500", cost: 0, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Sapporo+Concert+Hall+Kitara" }
                    ]
                },
                { 
                    date: "2/21", weekday: "SAT", title: "破冰船一日遊", 
                    img: "https://images.unsplash.com/photo-1544413647-15242313f58a?w=1000",
                    events: [
                        { timeFrom: "08:00", loc: "ANA 皇冠假日飯店", desc: "一日團集合出發。", icon: "fa-ship", color: "text-indigo-500", cost: 18500, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=ANA+Crowne+Plaza+Sapporo" }
                    ]
                },
                { 
                    date: "2/22", weekday: "SUN", title: "二条市場 · 返港", 
                    img: "https://images.unsplash.com/photo-1555529669-e69e730f162b?w=1000",
                    events: [
                        { timeFrom: "09:00", loc: "二条市場", desc: "海鮮早餐與乾貨購物。", icon: "fa-fish", color: "text-orange-500", cost: 5000, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nijo+Market" },
                        { timeFrom: "16:00", loc: "新千歲機場", desc: "辦理登機，啟程返港。", icon: "fa-plane-departure", color: "text-gray-500", cost: 1150, img: "", mapUrl: "https://www.google.com/maps/search/?api=1&query=New+Chitose+Airport" }
                    ]
                }
            ],
            checklist: [
                { task: "防滑鞋墊", done: false },
                { task: "比賽用樂譜", done: false },
                { task: "暖暖包", done: true }
            ],
            links: [{ title: "JR 北海道時刻表", url: "https://www.jrhokkaido.co.jp/" }],
            photos: [],
            documents: []
        };

        let appData = JSON.parse(JSON.stringify(defaultData));

        // ---核心引擎：全自動 Canvas 圖片壓縮 ---
        async function smartCompress(base64, maxWidth = 1200, quality = 0.6) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    if (w > maxWidth) {
                        h = (h * maxWidth) / w;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        }

        function saveData() { localStorage.setItem(STORE_KEY, JSON.stringify(appData)); }
        function loadData() {
            const saved = localStorage.getItem(STORE_KEY);
            if (saved) appData = JSON.parse(saved);
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0667&longitude=141.35&current_weather=true');
                const data = await res.json();
                document.getElementById('weather-display').innerText = `${Math.round(data.current_weather.temperature)}°C / 札幌市`;
            } catch (e) { document.getElementById('weather-display').innerText = '雪 / -3°C'; }
        }

        // --- 行程渲染 ---
        function renderDay(idx) {
            currentDayIdx = idx;
            const day = appData.itinerary[idx];
            if (!day) return;
            
            document.getElementById('day-img').src = day.img || '';
            document.getElementById('day-label').innerText = `Day ${idx + 1}`;
            
            const titleCont = document.getElementById('day-title-container');
            titleCont.innerHTML = isEditing ? 
                `<input type="text" oninput="appData.itinerary[${idx}].title=this.value" value="${day.title}" class="w-full bg-white/20 border-b border-white font-black text-2xl outline-none text-white">` : 
                `<h2 class="text-2xl font-black text-white">${day.title}</h2>`;

            const totalCost = day.events.reduce((sum, e) => sum + (parseInt(e.cost) || 0), 0);
            document.getElementById('day-budget').innerText = `¥ ${totalCost.toLocaleString()}`;

            const timeline = document.getElementById('timeline');
            timeline.innerHTML = `<div class="absolute left-[15px] top-2 bottom-2 w-px bg-gray-100"></div>`;
            
            day.events.forEach((ev, i) => {
                if (isEditing) {
                    timeline.innerHTML += `
                    <div class="relative pl-10 bg-gray-50 p-4 rounded-3xl border border-gray-100 animate-fade mb-4">
                        <div class="flex gap-2 mb-2">
                            <input type="text" oninput="appData.itinerary[${idx}].events[${i}].timeFrom=this.value" value="${ev.timeFrom||''}" placeholder="時間" class="w-full text-[10px] p-2 border rounded">
                            <input type="number" oninput="appData.itinerary[${idx}].events[${i}].cost=this.value" value="${ev.cost}" placeholder="¥" class="w-24 text-[10px] p-2 border rounded">
                        </div>
                        <input type="text" oninput="appData.itinerary[${idx}].events[${i}].loc=this.value" value="${ev.loc}" placeholder="地點名稱" class="w-full text-sm font-black mb-1 p-2 border rounded">
                        <input type="text" oninput="appData.itinerary[${idx}].events[${i}].mapUrl=this.value" value="${ev.mapUrl||''}" placeholder="Google Maps URL" class="w-full text-[9px] mb-2 p-2 border rounded text-blue-500">
                        <textarea oninput="appData.itinerary[${idx}].events[${i}].desc=this.value" class="w-full text-[10px] p-2 border rounded h-12 mb-2">${ev.desc}</textarea>
                        <div class="flex justify-between">
                            <button onclick="triggerImgUpload('event', {dayIdx:${idx}, eventIdx:${i}})" class="text-[9px] font-bold text-blue-500 underline">上傳圖片</button>
                            <button onclick="appData.itinerary[${idx}].events.splice(${i},1);renderDay(${idx})" class="text-[9px] font-bold text-red-400">刪除</button>
                        </div>
                    </div>`;
                } else {
                    const locHtml = ev.mapUrl ? 
                        `<a href="${ev.mapUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1.5 font-black text-[#0984e3] hover:opacity-70 transition-all">
                            <span>${ev.loc}</span><i class="fas fa-arrow-up-right-from-square text-[9px]"></i>
                        </a>` : `<h3 class="font-black text-[#2D3436]">${ev.loc}</h3>`;

                    timeline.innerHTML += `
                    <div class="relative pl-12 animate-fade">
                        <div class="absolute left-0 top-1 w-8 h-8 bg-white border border-gray-100 shadow-sm rounded-xl flex items-center justify-center z-10 ${ev.color}">
                            <i class="fas ${ev.icon} text-xs"></i>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <p class="text-[10px] font-black text-gray-400 mb-0.5">${ev.timeFrom || ''}</p>
                                ${locHtml}
                                <p class="text-xs text-gray-500 mt-1 leading-relaxed">${ev.desc}</p>
                            </div>
                            ${ev.img ? `<img src="${ev.img}" class="w-full h-40 object-cover rounded-3xl shadow-sm border border-gray-100">` : ''}
                            <div class="flex justify-between items-center text-[10px] font-bold text-gray-300 pt-2 border-t border-gray-50">
                                <span>行程點花費</span>
                                <span>¥ ${parseInt(ev.cost).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>`;
                }
            });
            document.querySelectorAll('.day-card').forEach((el, i) => el.classList.toggle('active', i === idx));
        }

        // --- 文件庫優化 ---
        document.getElementById('lib-file-input').onchange = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async (ev) => {
                let finalData = ev.target.result;
                if (file.type.startsWith('image/')) {
                    finalData = await smartCompress(finalData);
                }
                appData.documents.push({ 
                    name: file.name, 
                    data: finalData, 
                    date: new Date().toLocaleDateString(),
                    type: file.type
                });
                saveData();
                renderDocuments();
                document.getElementById('loading-overlay').style.display = 'none';
                e.target.value = "";
            };
            reader.readAsDataURL(file);
        };

        function renderDocuments() {
            const container = document.getElementById('document-list'); container.innerHTML = '';
            if (appData.documents.length === 0) {
                container.innerHTML = '<p class="text-[10px] text-white/30 text-center py-4">目前尚無檔案</p>';
                return;
            }
            appData.documents.forEach((doc, i) => {
                container.innerHTML += `
                <div class="flex items-center gap-3 p-4 bg-white/5 rounded-2xl border border-white/5 animate-fade">
                    <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-red-300">
                        <i class="fas ${doc.name.toLowerCase().endsWith('.pdf') ? 'fa-file-pdf' : 'fa-image'} text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-xs font-bold truncate">${doc.name}</h4>
                        <p class="text-[9px] text-white/40 font-black tracking-widest">${doc.date}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="viewDoc(${i})" class="w-9 h-9 rounded-xl bg-white/10 flex items-center justify-center"><i class="fas fa-eye text-xs"></i></button>
                        ${isEditing ? `<button onclick="appData.documents.splice(${i},1);saveData();renderDocuments();" class="w-9 h-9 rounded-xl bg-red-500/20 text-red-400 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>` : ''}
                    </div>
                </div>`;
            });
        }

        function viewDoc(idx) {
            const doc = appData.documents[idx];
            const win = window.open();
            if (doc.type === 'application/pdf') {
                win.document.write(`<iframe src="${doc.data}" frameborder="0" style="width:100%; height:100%;" allowfullscreen></iframe>`);
            } else {
                win.document.write(`<body style="margin:0; background:#000; display:flex; align-items:center; justify-content:center;"><img src="${doc.data}" style="max-width:100%; max-height:100%; object-fit:contain;"></body>`);
            }
        }

        // --- 圖片上傳壓縮 ---
        function triggerImgUpload(target, extra = null) {
            uploadMeta = { type: target, extra };
            document.getElementById('global-img-input').click();
        }

        document.getElementById('global-img-input').onchange = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const compressedBase64 = await smartCompress(ev.target.result);
                if (uploadMeta.type === 'banner') appData.itinerary[currentDayIdx].img = compressedBase64;
                else if (uploadMeta.type === 'event') appData.itinerary[uploadMeta.extra.dayIdx].events[uploadMeta.extra.eventIdx].img = compressedBase64;
                else if (uploadMeta.type === 'gallery') appData.photos.push({ url: compressedBase64 });
                saveData();
                renderDay(currentDayIdx);
                renderPhotos();
                document.getElementById('loading-overlay').style.display = 'none';
                e.target.value = "";
            };
            reader.readAsDataURL(file);
        };

        // --- 其他工具 ---
        function renderLinks() {
            const list = document.getElementById('link-list'); list.innerHTML = '';
            appData.links.forEach((l, i) => {
                if (isEditing) {
                    list.innerHTML += `<div class="flex gap-2"><input value="${l.title}" oninput="appData.links[${i}].title=this.value" class="flex-1 text-xs p-2 border rounded"><input value="${l.url}" oninput="appData.links[${i}].url=this.value" class="flex-1 text-xs p-2 border rounded"><button onclick="appData.links.splice(${i},1);renderLinks()" class="text-red-400"><i class="fas fa-times"></i></button></div>`;
                } else {
                    list.innerHTML += `<a href="${l.url}" target="_blank" class="block p-4 bg-gray-50 rounded-2xl border border-gray-100 text-sm font-bold text-gray-600 flex justify-between items-center">${l.title} <i class="fas fa-external-link-alt text-[10px] opacity-20"></i></a>`;
                }
            });
        }

        function renderChecklist() {
            const list = document.getElementById('checklist'); list.innerHTML = '';
            appData.checklist.forEach((item, i) => {
                list.innerHTML += `<div class="flex items-center gap-3 p-4 rounded-2xl bg-white border border-gray-100 shadow-sm" onclick="${!isEditing ? `appData.checklist[${i}].done=!appData.checklist[${i}].done;saveData();renderChecklist()` : ''}">
                    <div class="w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.done ? 'bg-orange-500 border-orange-500 text-white' : 'border-gray-200'}">
                        ${item.done ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </div>
                    <div class="flex-1">${isEditing ? `<input value="${item.task}" oninput="appData.checklist[${i}].task=this.value" class="w-full bg-transparent outline-none text-sm font-bold">` : `<span class="text-sm font-bold ${item.done ? 'line-through text-gray-300' : ''}">${item.task}</span>`}</div>
                    ${isEditing ? `<button onclick="appData.checklist.splice(${i},1);renderChecklist()" class="text-red-300"><i class="fas fa-trash text-xs"></i></button>` : ''}
                </div>`;
            });
            if(isEditing) list.innerHTML += `<button onclick="appData.checklist.push({task:'待辦事項',done:false});renderChecklist()" class="w-full py-3 border-2 border-dashed border-gray-100 rounded-2xl text-[10px] font-black text-gray-400">+ 加入新項目</button>`;
        }

        function renderPhotos() {
            const gallery = document.getElementById('photo-gallery'); gallery.innerHTML = '';
            appData.photos.forEach((p, i) => {
                gallery.innerHTML += `<div class="relative rounded-2xl overflow-hidden aspect-square border border-gray-100"><img src="${p.url}" class="w-full h-full object-cover">${isEditing ? `<button onclick="appData.photos.splice(${i},1);saveData();renderPhotos();" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px]"><i class="fas fa-times"></i></button>` : ''}</div>`;
            });
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const btn = document.getElementById('edit-btn');
            btn.innerHTML = isEditing ? '<i class="fas fa-save"></i> 結束編輯' : '<i class="fas fa-edit"></i> 編輯模式';
            btn.classList.toggle('bg-green-600', isEditing);
            document.getElementById('add-event-container').classList.toggle('hidden', !isEditing);
            document.getElementById('add-link-btn').classList.toggle('hidden', !isEditing);
            document.getElementById('add-photo-btn').classList.toggle('hidden', !isEditing);
            document.getElementById('banner-upload-btn').classList.toggle('hidden', !isEditing);
            document.getElementById('add-doc-btn').classList.toggle('hidden', !isEditing);
            if (!isEditing) saveData();
            renderDay(currentDayIdx); renderLinks(); renderChecklist(); renderPhotos(); renderDocuments();
        }

        function switchTab(tab) {
            document.getElementById('content-itinerary').classList.toggle('hidden', tab !== 'itinerary');
            document.getElementById('content-tools').classList.toggle('hidden', tab !== 'tools');
            document.getElementById('ind-itinerary').classList.toggle('hidden', tab !== 'itinerary');
            document.getElementById('ind-tools').classList.toggle('hidden', tab !== 'tools');
            document.getElementById('tab-itinerary').classList.toggle('text-gray-300', tab !== 'itinerary');
            document.getElementById('tab-tools').classList.toggle('text-gray-300', tab !== 'tools');
        }

        function addEvent() { appData.itinerary[currentDayIdx].events.push({ timeFrom: "12:00", loc: "新景點", desc: "", icon: "fa-map-marker-alt", color: "text-blue-500", cost: 0, img: "", mapUrl: "" }); renderDay(currentDayIdx); }
        function addLink() { appData.links.push({ title: "新網頁", url: "https://" }); renderLinks(); }
        function convertCurrency(type) { const jpy = document.getElementById('jpy-input'); const hkd = document.getElementById('hkd-input'); if (type === 'jpy') hkd.value = jpy.value ? (jpy.value * exchangeRate).toFixed(2) : ''; else jpy.value = hkd.value ? (hkd.value / exchangeRate).toFixed(0) : ''; }
        function resetData() { if (confirm("確定要重置所有本地資料嗎？此操作不可逆。")) { localStorage.removeItem(STORE_KEY); location.reload(); } }

        function initDaySelector() {
            const s = document.getElementById('day-selector'); s.innerHTML = '';
            appData.itinerary.forEach((day, i) => {
                s.innerHTML += `<button onclick="renderDay(${i})" class="day-card flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center bg-white shadow-sm transition-all border border-gray-100 font-black">
                    <span class="text-[9px] opacity-40 uppercase">Feb</span>
                    <span class="text-xl">${day.date.split('/')[1]}</span>
                </button>`;
            });
        }

        window.onload = () => {
            loadData();
            initDaySelector();
            renderDay(0);
            renderLinks();
            renderChecklist();
            renderPhotos();
            renderDocuments();
            fetchWeather();
        };
    </script>
</body>
</html>
