<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapporo 2026 | Mobile Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .day-card.active { background: #2D3436; color: white; transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        
        #loading-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.85); 
            z-index: 10000; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: white; 
        }
        .img-gradient { background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.8)); }
        .event-img-container { position: relative; width: 100%; max-height: 250px; border-radius: 1rem; overflow: hidden; margin-top: 0.75rem; border: 1px solid #eee; background: #f9f9f9; }
        .timeline-dot { position: absolute; left: 12px; top: 4px; width: 10px; height: 10px; border-radius: 50%; background: #0984e3; border: 2px solid white; z-index: 20; }
    </style>
</head>
<body class="bg-[#F8F9FA] text-[#2D3436] pb-24">

    <!-- 手機上傳優化：將 input 置頂並增加 accept 屬性 -->
    <input type="file" id="banner-img-input" class="hidden" accept="image/jpeg,image/png,image/webp">
    <input type="file" id="event-img-input" class="hidden" accept="image/jpeg,image/png,image/webp">
    <input type="file" id="lib-file-input" class="hidden" accept="image/jpeg,image/png,image/webp">

    <!-- 載入遮罩 -->
    <div id="loading-overlay">
        <div class="relative w-12 h-12 mb-4">
            <div class="absolute inset-0 border-4 border-white/10 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="font-black text-xs tracking-widest uppercase">正在壓縮圖片...請稍候</p>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 glass border-b border-gray-100 p-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-[#0984e3] to-[#74b9ff] rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-snowflake"></i>
            </div>
            <div>
                <h1 class="text-sm font-black tracking-tight mb-1">Sapporo 2026</h1>
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                    <i class="fas fa-calendar-alt text-blue-500"></i> FEB 16 - FEB 22
                </p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="resetData()" class="px-2 py-2 text-gray-300"><i class="fas fa-trash-alt"></i></button>
            <button id="edit-btn" onclick="toggleEdit()" class="px-4 py-2 bg-[#2D3436] text-white rounded-xl font-black text-[11px] shadow-md flex items-center gap-2 active:scale-95 transition-all">
                <i class="fas fa-edit"></i> <span>編輯模式</span>
            </button>
        </div>
    </header>

    <!-- Tab 導覽 -->
    <nav class="flex px-6 pt-4 gap-8 border-b border-gray-100 bg-white sticky top-[73px] z-40">
        <button onclick="switchTab('itinerary')" id="tab-itinerary" class="pb-3 text-[11px] font-black uppercase tracking-widest relative text-[#2D3436]">
            行程導航
            <div id="ind-itinerary" class="absolute bottom-0 left-0 right-0 h-1 bg-[#0984e3] rounded-full"></div>
        </button>
        <button onclick="switchTab('tools')" id="tab-tools" class="pb-3 text-[11px] font-black uppercase tracking-widest relative text-gray-300">
            清單與文件
            <div id="ind-tools" class="hidden absolute bottom-0 left-0 right-0 h-1 bg-[#0984e3] rounded-full"></div>
        </button>
    </nav>

    <main class="p-4 max-w-2xl mx-auto space-y-6">
        
        <!-- 行程內容 -->
        <section id="content-itinerary" class="space-y-6 animate-fade">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[9px] font-black text-gray-400 uppercase">札幌天氣</p>
                        <p id="weather-display" class="text-sm font-black text-blue-600">載入中...</p>
                    </div>
                    <div id="weather-icon"><i class="fas fa-snowflake text-blue-100 text-lg"></i></div>
                </div>
                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm">
                    <p class="text-[9px] font-black text-gray-400 uppercase mb-2">JPY ↔ HKD (0.052)</p>
                    <div class="flex gap-2">
                        <input type="number" id="jpy-input" oninput="convertCurrency('jpy')" placeholder="¥" class="w-full bg-gray-50 rounded-lg p-1 text-xs font-black outline-none">
                        <input type="number" id="hkd-input" oninput="convertCurrency('hkd')" placeholder="$" class="w-full bg-blue-50/50 rounded-lg p-1 text-xs font-black outline-none text-blue-600">
                    </div>
                </div>
            </div>

            <div class="flex gap-3 overflow-x-auto no-scrollbar py-2" id="day-selector"></div>

            <div id="day-details" class="bg-white rounded-[2.5rem] overflow-hidden shadow-xl border border-gray-100">
                <div id="day-banner" class="h-56 relative bg-gray-200">
                    <img id="day-img" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 img-gradient"></div>
                    <button id="banner-upload-btn" onclick="triggerInput('banner-img-input')" class="hidden absolute top-4 right-4 w-10 h-10 bg-black/40 backdrop-blur-md border border-white/30 rounded-full text-white flex items-center justify-center">
                        <i class="fas fa-camera"></i>
                    </button>
                    <div class="absolute bottom-6 left-8 right-8 flex justify-between items-end text-white">
                        <div>
                            <span id="day-label" class="inline-block px-3 py-0.5 bg-blue-500 rounded-full text-[10px] font-black uppercase mb-2">Day</span>
                            <div id="day-title-container"></div>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold opacity-70">當日預算</p>
                            <p id="day-budget" class="text-xl font-black">¥ 0</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-8">
                    <div id="timeline" class="space-y-12 relative"></div>
                    <div id="add-event-container" class="hidden mt-10">
                        <button onclick="addEvent()" class="w-full py-4 border-2 border-dashed border-gray-200 rounded-3xl text-gray-400 font-black text-xs">
                            <i class="fas fa-plus mr-2"></i> 新增行程項目
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 清單與文件 (優化後的圖片壓縮庫) -->
        <section id="content-tools" class="hidden space-y-6 animate-fade">
            <div class="bg-[#2D3436] p-6 rounded-[2.5rem] shadow-xl text-white">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-images text-blue-400"></i>
                        <h2 class="text-lg font-black tracking-tight text-white">文件圖庫 (壓縮圖片)</h2>
                    </div>
                    <button id="add-doc-btn" onclick="triggerInput('lib-file-input')" class="hidden px-5 py-2.5 bg-blue-500 text-white rounded-xl text-[10px] font-black shadow-lg tracking-widest">
                        上傳照片
                    </button>
                </div>
                <div id="document-list" class="space-y-2"></div>
            </div>

            <!-- 重要連結 -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-link text-blue-500"></i>
                        <h2 class="text-xl font-black tracking-tight">重要連結</h2>
                    </div>
                    <button id="add-link-btn" onclick="addLink()" class="hidden px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-[10px] font-black">新增連結</button>
                </div>
                <div id="link-list" class="space-y-3"></div>
            </div>

            <!-- 出發準備 -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-clipboard-list text-orange-500"></i>
                        <h2 class="text-xl font-black tracking-tight">出發準備</h2>
                    </div>
                    <button id="add-check-btn" onclick="addCheckItem()" class="hidden px-4 py-2 bg-orange-50 text-orange-600 rounded-xl text-[10px] font-black">新增項目</button>
                </div>
                <div id="checklist" class="space-y-3"></div>
            </div>
        </section>
    </main>

    <script>
        const STORE_KEY = 'SAPPORO_V16_STABLE';
        const exchangeRate = 0.052;
        let currentDayIdx = 0;
        let isEditing = false;
        let activeEventIdx = null;

        const defaultData = {
            itinerary: [
                { date: "2/16", weekday: "MON", title: "啟程 · 札幌初雪", img: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=1000", events: [{ timeFrom: "15:00", timeTo: "16:30", loc: "新千歲機場", desc: "抵達後搭乘 JR 快速 Airport 號。", cost: 1150, eventImg: "" }] },
                { date: "2/17", weekday: "TUE", title: "音樂決賽日 @ Sun Plaza", img: "https://images.unsplash.com/photo-1520529688591-b213eb5ee9a3?w=1000", events: [] },
                { date: "2/18", weekday: "WED", title: "小樽浪漫漫步", img: "https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=1000", events: [] },
                { date: "2/19", weekday: "THU", title: "札幌國際滑雪場", img: "https://images.unsplash.com/photo-1454496522488-7a8e488e8606?w=1000", events: [] },
                { date: "2/20", weekday: "FRI", title: "頒獎禮 @ Kitara", img: "https://images.unsplash.com/photo-1507838596357-01242f2105a9?w=1000", events: [] },
                { date: "2/21", weekday: "SAT", title: "網走破冰船一日遊", img: "https://images.unsplash.com/photo-1480497490787-505ec076689f?w=1000", events: [] },
                { date: "2/22", weekday: "SUN", title: "二条市場 · 歸國", img: "https://images.unsplash.com/photo-1534422298391-e4f8c172dddb?w=1000", events: [] }
            ],
            checklist: [{ task: "保暖鞋墊 (便利店買)", done: false }, { task: "護照及文件", done: true }],
            links: [{ title: "JR 北海道時刻表", url: "https://www.jrhokkaido.co.jp/" }],
            documents: []
        };

        let appData = JSON.parse(JSON.stringify(defaultData));

        // --- 手機優化：手動觸發 input ---
        function triggerInput(id) {
            document.getElementById(id).click();
        }

        // --- 手機優化：圖片壓縮引擎 ---
        async function smartCompress(file, maxWidth = 900, quality = 0.5) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        // 強制輸出為 jpeg 並進一步降低品質以適應手機存儲
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function saveData() { 
            try {
                localStorage.setItem(STORE_KEY, JSON.stringify(appData));
            } catch (e) {
                alert("儲存空間不足，請刪除部分圖片後再試！");
            }
        }
        function loadData() { const saved = localStorage.getItem(STORE_KEY); if (saved) appData = JSON.parse(saved); }

        // 文件上傳
        document.getElementById('lib-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoading(true);
            try {
                const compressedData = await smartCompress(file);
                appData.documents.push({ 
                    name: file.name.substring(0, 15), 
                    data: compressedData, 
                    date: new Date().toLocaleDateString() 
                });
                saveData(); renderDocuments();
            } catch (err) { console.error(err); }
            showLoading(false);
        });

        // 行程圖上傳
        document.getElementById('event-img-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || activeEventIdx === null) return;
            showLoading(true);
            try {
                const compressed = await smartCompress(file, 800, 0.4);
                appData.itinerary[currentDayIdx].events[activeEventIdx].eventImg = compressed;
                saveData(); renderDay(currentDayIdx);
            } catch (err) { console.error(err); }
            showLoading(false);
        });

        // Banner 上傳
        document.getElementById('banner-img-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoading(true);
            try {
                const compressed = await smartCompress(file, 1000, 0.6);
                appData.itinerary[currentDayIdx].img = compressed;
                saveData(); renderDay(currentDayIdx);
            } catch (err) { console.error(err); }
            showLoading(false);
        });

        function viewDoc(idx) {
            const doc = appData.documents[idx];
            const newWindow = window.open("");
            newWindow.document.write(`<body style="margin:0; background:#000; display:flex; align-items:center; justify-content:center;"><img src="${doc.data}" style="max-width:100%; max-height:100%; object-fit:contain;"></body>`);
        }

        // --- 介面渲染 (保留所有原本邏輯) ---
        function renderDocuments() {
            const container = document.getElementById('document-list'); 
            container.innerHTML = appData.documents.length ? '' : '<div class="text-[11px] text-white/30 text-center py-12 italic tracking-widest uppercase">暫無壓縮圖片</div>';
            appData.documents.forEach((doc, i) => {
                container.innerHTML += `
                <div class="flex items-center gap-3 p-4 bg-white/5 rounded-2xl border border-white/5 animate-fade">
                    <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-blue-300">
                        <i class="fas fa-image text-sm"></i>
                    </div>
                    <div class="flex-1 truncate">
                        <h4 class="text-xs font-black truncate text-white/90">${doc.name}</h4>
                        <p class="text-[9px] text-white/40 uppercase tracking-widest">壓縮圖 • ${doc.date}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="viewDoc(${i})" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-[10px] font-black transition-all">查看</button>
                        ${isEditing ? `<button onclick="appData.documents.splice(${i},1);saveData();renderDocuments();" class="w-9 h-9 bg-red-500/20 text-red-400 rounded-xl flex items-center justify-center"><i class="fas fa-trash-alt text-xs"></i></button>` : ''}
                    </div>
                </div>`;
            });
        }

        function renderDay(idx) {
            currentDayIdx = idx;
            const day = appData.itinerary[idx];
            document.getElementById('day-img').src = day.img || '';
            document.getElementById('day-label').innerText = `Day ${idx + 1} • FEB ${day.date.split('/')[1]} (${day.weekday})`;
            
            const titleCont = document.getElementById('day-title-container');
            titleCont.innerHTML = isEditing ? 
                `<input type="text" oninput="appData.itinerary[${idx}].title=this.value" value="${day.title}" class="w-full bg-white/20 border-b border-white font-black text-xl outline-none text-white p-1">` : 
                `<h2 class="text-2xl font-black text-white">${day.title}</h2>`;

            const totalCost = day.events.reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
            document.getElementById('day-budget').innerText = `¥ ${totalCost.toLocaleString()}`;

            const timeline = document.getElementById('timeline');
            timeline.innerHTML = `<div class="absolute left-[16px] top-2 bottom-2 w-px bg-gray-100"></div>`;
            
            day.events.forEach((ev, i) => {
                if (isEditing) {
                    timeline.innerHTML += `
                    <div class="relative pl-10 bg-gray-50 p-4 rounded-3xl border border-gray-100 mb-4 animate-fade">
                        <div class="flex gap-2 mb-2">
                            <input type="time" oninput="appData.itinerary[${idx}].events[${i}].timeFrom=this.value" value="${ev.timeFrom||''}" class="flex-1 text-[10px] p-2 border rounded font-bold">
                            <input type="time" oninput="appData.itinerary[${idx}].events[${i}].timeTo=this.value" value="${ev.timeTo||''}" class="flex-1 text-[10px] p-2 border rounded font-bold">
                            <input type="number" oninput="appData.itinerary[${idx}].events[${i}].cost=this.value" value="${ev.cost}" placeholder="¥" class="w-20 text-[10px] p-2 border rounded font-bold">
                        </div>
                        <input type="text" oninput="appData.itinerary[${idx}].events[${i}].loc=this.value" value="${ev.loc}" class="w-full text-sm font-black mb-2 p-2 border rounded" placeholder="地點名稱">
                        <textarea oninput="appData.itinerary[${idx}].events[${i}].desc=this.value" class="w-full text-[10px] p-2 border rounded h-16 outline-none" placeholder="備註內容">${ev.desc}</textarea>
                        
                        <div class="flex gap-4 mt-3">
                            <button onclick="activeEventIdx=${i};triggerInput('event-img-input')" class="text-[9px] font-black text-blue-500 uppercase tracking-widest flex items-center gap-1">
                                <i class="fas fa-camera"></i> ${ev.eventImg ? '更換配圖' : '加入項目圖'}
                            </button>
                            <button onclick="appData.itinerary[${idx}].events.splice(${i},1);renderDay(${idx})" class="text-[9px] font-black text-red-500 uppercase tracking-widest flex items-center gap-1">
                                <i class="fas fa-trash-alt"></i> 刪除項目
                            </button>
                        </div>
                        ${ev.eventImg ? `<div class="event-img-container mt-2 opacity-50 grayscale"><img src="${ev.eventImg}" class="w-full h-full object-cover"></div>` : ''}
                    </div>`;
                } else {
                    timeline.innerHTML += `
                    <div class="relative pl-12 animate-fade">
                        <div class="timeline-dot"></div>
                        <div>
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">${ev.timeFrom || '--:--'} ${ev.timeTo ? `— ${ev.timeTo}` : ''}</p>
                            <div class="flex items-center gap-2">
                                <h3 class="font-black text-sm text-[#2D3436]">${ev.loc}</h3>
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.loc)}" target="_blank" class="text-blue-500 text-[10px]"><i class="fas fa-location-arrow"></i></a>
                            </div>
                            <p class="text-[11px] text-gray-500 mt-1">${ev.desc}</p>
                            <p class="text-[10px] font-black mt-2 text-gray-800">¥ ${(ev.cost || 0).toLocaleString()}</p>
                            ${ev.eventImg ? `<div class="event-img-container"><img src="${ev.eventImg}" class="w-full h-full object-cover"></div>` : ''}
                        </div>
                    </div>`;
                }
            });
            document.querySelectorAll('.day-card').forEach((el, i) => el.classList.toggle('active', i === idx));
        }

        function renderChecklist() {
            const list = document.getElementById('checklist'); list.innerHTML = '';
            appData.checklist.forEach((item, i) => {
                list.innerHTML += `<div class="flex items-center gap-3 p-4 rounded-2xl bg-white border border-gray-100 animate-fade" onclick="${!isEditing ? `appData.checklist[${i}].done=!appData.checklist[${i}].done;saveData();renderChecklist()` : ''}"><div class="w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.done ? 'bg-orange-500 border-orange-500 text-white' : 'border-gray-200'}">${item.done ? '<i class="fas fa-check text-[10px]"></i>' : ''}</div><div class="flex-1">${isEditing ? `<input value="${item.task}" oninput="appData.checklist[${i}].task=this.value" class="w-full text-sm font-bold bg-transparent outline-none">` : `<span class="text-sm font-bold ${item.done ? 'line-through text-gray-300' : ''}">${item.task}</span>`}</div>${isEditing ? `<button onclick="appData.checklist.splice(${i},1);renderChecklist()" class="text-red-300 px-2"><i class="fas fa-times-circle text-lg"></i></button>` : ''}</div>`;
            });
        }

        function renderLinks() {
            const list = document.getElementById('link-list'); list.innerHTML = '';
            appData.links.forEach((l, i) => {
                list.innerHTML += `<div class="flex gap-2"><a href="${l.url}" target="_blank" class="flex-1 p-4 bg-gray-50 rounded-2xl text-sm font-bold flex justify-between items-center active:scale-[0.98] transition-all">${isEditing ? `<input value="${l.title}" oninput="appData.links[${i}].title=this.value" class="bg-transparent outline-none w-full mr-2">` : `<span>${l.title}</span>`}<i class="fas fa-external-link-alt text-xs text-gray-300"></i></a>${isEditing ? `<button onclick="appData.links.splice(${i},1);renderLinks()" class="px-2 text-red-300"><i class="fas fa-trash-alt"></i></button>` : ''}</div>`;
            });
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const btn = document.getElementById('edit-btn');
            btn.innerHTML = isEditing ? '<i class="fas fa-check"></i> 儲存修改' : '<i class="fas fa-edit"></i> 編輯模式';
            btn.classList.toggle('bg-green-600', isEditing); btn.classList.toggle('bg-[#2D3436]', !isEditing);
            ['add-event-container', 'banner-upload-btn', 'add-doc-btn', 'add-link-btn', 'add-check-btn'].forEach(id => document.getElementById(id).classList.toggle('hidden', !isEditing));
            if (!isEditing) saveData();
            renderDay(currentDayIdx); renderChecklist(); renderDocuments(); renderLinks();
        }

        function switchTab(tab) {
            document.getElementById('content-itinerary').classList.toggle('hidden', tab !== 'itinerary');
            document.getElementById('content-tools').classList.toggle('hidden', tab !== 'tools');
            document.getElementById('ind-itinerary').classList.toggle('hidden', tab !== 'itinerary');
            document.getElementById('ind-tools').classList.toggle('hidden', tab !== 'tools');
            document.getElementById('tab-itinerary').classList.toggle('text-gray-300', tab !== 'itinerary');
            document.getElementById('tab-tools').classList.toggle('text-gray-300', tab !== 'tools');
        }

        function convertCurrency(type) { 
            const jpy = document.getElementById('jpy-input'), hkd = document.getElementById('hkd-input'); 
            if (type === 'jpy') hkd.value = (jpy.value * exchangeRate).toFixed(2); 
            else jpy.value = (hkd.value / exchangeRate).toFixed(0); 
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0667&longitude=141.35&current_weather=true');
                const data = await res.json();
                document.getElementById('weather-display').innerText = `${Math.round(data.current_weather.temperature)}°C / 札幌`;
            } catch (e) { document.getElementById('weather-display').innerText = '-2°C / 札幌'; }
        }

        function initDaySelector() {
            const s = document.getElementById('day-selector'); s.innerHTML = '';
            appData.itinerary.forEach((day, i) => {
                s.innerHTML += `<button onclick="renderDay(${i})" class="day-card flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center bg-white border border-gray-100 font-black transition-all"><span class="text-[9px] opacity-40 uppercase">FEB</span><span class="text-xl">${day.date.split('/')[1]}</span></button>`;
            });
        }

        function resetData() { if (confirm("確定重置所有行程與數據？")) { localStorage.removeItem(STORE_KEY); location.reload(); } }
        function addEvent() { appData.itinerary[currentDayIdx].events.push({ timeFrom: "09:00", timeTo: "10:00", loc: "新行程項目", desc: "", cost: 0, eventImg: "" }); renderDay(currentDayIdx); }
        function addCheckItem() { appData.checklist.push({ task: "待辦項目", done: false }); renderChecklist(); }
        function addLink() { appData.links.push({ title: "新連結", url: "https://" }); renderLinks(); }

        window.onload = () => { loadData(); initDaySelector(); renderDay(0); renderChecklist(); renderDocuments(); renderLinks(); fetchWeather(); };
    </script>
</body>
</html>
