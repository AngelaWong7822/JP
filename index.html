<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sapporo 2026 | Japanese Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --jp-red: #D63031;
            --jp-blue: #0984e3;
            --jp-ink: #2D3436;
            --jp-paper: #FDFCF0; /* 和紙色 */
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #F7F8FA;
            color: var(--jp-ink);
        }

        /* 和風裝飾圖案 */
        .seigaiha {
            background-image: radial-gradient(circle at 100% 150%, silver 24%, white 25%, white 28%, silver 29%, silver 36%, white 36%, white 40%, transparent 40%),
                              radial-gradient(circle at 0 150%, silver 24%, white 25%, white 28%, silver 29%, silver 36%, white 36%, white 40%, transparent 40%),
                              radial-gradient(circle at 50% 100%, white 10%, silver 11%, silver 23%, white 24%, white 30%, silver 31%, silver 43%, white 44%, white 50%, transparent 50%),
                              radial-gradient(circle at 100% 50%, white 5%, silver 6%, silver 15%, white 16%, white 20%, silver 21%, silver 30%, white 31%, white 35%, transparent 35%),
                              radial-gradient(circle at 0 50%, white 5%, silver 6%, silver 15%, white 16%, white 20%, silver 21%, silver 30%, white 31%, white 35%, transparent 35%);
            background-size: 40px 20px;
            opacity: 0.05;
            position: absolute; inset: 0; pointer-events: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        
        .day-card.active { 
            background: var(--jp-ink); 
            color: white; 
            transform: scale(1.05); 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); 
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* 檔案上傳讀取中 */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        /* 燈箱預覽樣式 */
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10001; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #lightbox img { max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 12px; }

        .img-gradient { background: linear-gradient(to bottom, transparent 30%, rgba(0,0,0,0.7)); }
        .event-img-container { position: relative; width: 100%; max-height: 280px; border-radius: 1.5rem; overflow: hidden; margin-top: 1rem; border: 1px solid #eee; }
        
        .timeline-line { position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: #E5E7EB; z-index: 0; }
        .timeline-dot { position: absolute; left: 16px; width: 10px; height: 10px; border-radius: 50%; background: var(--jp-red); border: 2px solid white; z-index: 10; margin-top: 6px; }

        /* 行動端按鈕優化 */
        .btn-tap { transition: all 0.2s; }
        .btn-tap:active { transform: scale(0.92); opacity: 0.8; }
    </style>
</head>
<body class="pb-32">

    <!-- 隱藏 Input -->
    <input type="file" id="banner-img-input" class="hidden" accept="image/*">
    <input type="file" id="event-img-input" class="hidden" accept="image/*">
    <input type="file" id="lib-file-input" class="hidden" accept="image/*">

    <!-- 狀態覆蓋層 -->
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-red-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold tracking-widest">和風速寫中...</p>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="Preview">
        <p class="mt-4 text-white/50 text-xs">點擊背景返回</p>
    </div>

    <!-- 頂部資訊欄 -->
    <header class="sticky top-0 z-50 glass border-b border-gray-100 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-[var(--jp-red)] rounded-full flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-torii-gate"></i>
            </div>
            <div>
                <h1 class="text-base font-black tracking-tight leading-none">札幌旅行 2026</h1>
                <p class="text-[9px] font-bold text-gray-400 mt-1 uppercase tracking-widest">Sapporo Winter Tour</p>
            </div>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="resetData()" class="p-2 text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt text-sm"></i></button>
            <button id="edit-btn" onclick="toggleEdit()" class="btn-tap px-4 py-2 bg-[var(--jp-ink)] text-white rounded-full font-bold text-[11px] shadow-lg flex items-center gap-2">
                <i class="fas fa-paint-brush"></i> <span>編輯</span>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- 行程導航 -->
        <section id="content-itinerary" class="space-y-6 animate-slide">
            
            <!-- 天氣與匯率 (和風卡片) -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-3">
                    <div id="weather-icon" class="text-2xl text-blue-400">
                        <i class="fas fa-snowflake"></i>
                    </div>
                    <div>
                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest">札幌 天氣</p>
                        <p id="weather-display" class="text-sm font-black text-[var(--jp-ink)]">載入中...</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-100">
                    <p class="text-[8px] font-black text-gray-400 uppercase mb-1 tracking-widest">JPY ↔ HKD (0.052)</p>
                    <div class="flex items-center gap-1">
                        <input type="number" id="jpy-input" oninput="convertCurrency('jpy')" placeholder="¥" class="w-full bg-gray-50 rounded-lg p-1 text-xs font-bold outline-none">
                        <i class="fas fa-exchange-alt text-[10px] text-gray-300"></i>
                        <input type="number" id="hkd-input" oninput="convertCurrency('hkd')" placeholder="$" class="w-full bg-red-50 rounded-lg p-1 text-xs font-bold outline-none text-[var(--jp-red)]">
                    </div>
                </div>
            </div>

            <!-- 日期選擇器 -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar py-2 px-1" id="day-selector"></div>

            <!-- 主行程展示區 -->
            <div id="day-details" class="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl shadow-black/5 border border-gray-100 relative">
                <div class="seigaiha"></div>
                
                <div id="day-banner" class="h-64 relative bg-gray-200">
                    <img id="day-img" src="" class="w-full h-full object-cover" onclick="openLightbox(this.src)">
                    <div class="absolute inset-0 img-gradient pointer-events-none"></div>
                    
                    <button id="banner-upload-btn" onclick="triggerInput('banner-img-input')" class="hidden absolute top-6 right-6 w-12 h-12 bg-white/20 backdrop-blur-md border border-white/40 rounded-full text-white flex items-center justify-center btn-tap">
                        <i class="fas fa-camera text-lg"></i>
                    </button>

                    <div class="absolute bottom-8 left-8 right-8 flex justify-between items-end text-white">
                        <div class="pointer-events-none">
                            <span id="day-label" class="inline-block px-3 py-1 bg-[var(--jp-red)] rounded-full text-[9px] font-black uppercase mb-2 tracking-widest">DAY 1</span>
                            <div id="day-title-container" class="pointer-events-auto"></div>
                        </div>
                        <div class="text-right pointer-events-none">
                            <p class="text-[9px] font-bold opacity-60 uppercase tracking-widest">當日預算</p>
                            <p id="day-budget" class="text-2xl font-black">¥ 0</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-8 relative">
                    <div id="timeline" class="space-y-10 relative min-h-[200px]">
                        <!-- Timeline Line & Dots will be injected here -->
                    </div>
                    
                    <div id="add-event-container" class="hidden mt-12">
                        <button onclick="addEvent()" class="w-full py-5 border-2 border-dashed border-gray-200 rounded-[2rem] text-gray-300 font-bold text-xs hover:border-red-200 hover:text-red-400 transition-all">
                            <i class="fas fa-plus-circle mr-2 text-lg"></i> 新增行程項目
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 工具頁面 (清單與文件) -->
        <section id="content-tools" class="hidden space-y-6 animate-slide">
            
            <!-- 文件圖庫 -->
            <div class="bg-[var(--jp-ink)] p-8 rounded-[2.5rem] shadow-xl text-white relative overflow-hidden">
                <div class="seigaiha opacity-10"></div>
                <div class="flex justify-between items-center mb-8 relative">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-folder-open text-[var(--jp-red)] text-xl"></i>
                        <h2 class="text-xl font-black tracking-tight">旅行文件</h2>
                    </div>
                    <button id="add-doc-btn" onclick="triggerInput('lib-file-input')" class="hidden btn-tap px-5 py-2.5 bg-white text-black rounded-full text-[10px] font-black">
                        上傳相片
                    </button>
                </div>
                <div id="document-list" class="space-y-3 relative"></div>
            </div>

            <!-- 出發清單 -->
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black tracking-tight flex items-center gap-3">
                        <span class="w-1.5 h-6 bg-[var(--jp-red)] rounded-full"></span>
                        準備清單
                    </h2>
                    <button id="add-check-btn" onclick="addCheckItem()" class="hidden px-4 py-2 bg-gray-50 text-gray-400 rounded-full text-[10px] font-black">新增項目</button>
                </div>
                <div id="checklist" class="space-y-3"></div>
            </div>

            <!-- 連結 -->
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black tracking-tight flex items-center gap-3">
                        <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>
                        實用連結
                    </h2>
                    <button id="add-link-btn" onclick="addLink()" class="hidden px-4 py-2 bg-gray-50 text-gray-400 rounded-full text-[10px] font-black">新增連結</button>
                </div>
                <div id="link-list" class="space-y-3"></div>
            </div>
        </section>
    </main>

    <!-- 底部切換列 (Mobile Friendly) -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm glass rounded-[2.5rem] border border-white/50 shadow-2xl z-[100] flex p-2 gap-2 overflow-hidden">
        <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-4 flex flex-col items-center justify-center gap-1 rounded-[2rem] transition-all bg-[var(--jp-ink)] text-white">
            <i class="fas fa-map-marked-alt text-lg"></i>
            <span class="text-[9px] font-black uppercase tracking-widest">行程導覽</span>
        </button>
        <button onclick="switchTab('tools')" id="tab-tools" class="flex-1 py-4 flex flex-col items-center justify-center gap-1 rounded-[2rem] transition-all text-gray-400">
            <i class="fas fa-list-ul text-lg"></i>
            <span class="text-[9px] font-black uppercase tracking-widest">清單文件</span>
        </button>
    </nav>

    <script>
        const STORE_KEY = 'SAPPORO_JP_V1';
        const exchangeRate = 0.052;
        let currentDayIdx = 0;
        let isEditing = false;
        let activeEventIdx = null;

        const defaultData = {
            itinerary: [
                { date: "2/16", weekday: "MON", title: "啟程 · 札幌初雪", img: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=1000", events: [{ timeFrom: "15:00", timeTo: "16:30", loc: "新千歲機場", desc: "抵達後搭乘 JR 快速 Airport 號。", cost: 1150, eventImg: "" }] },
                { date: "2/17", weekday: "TUE", title: "音樂決賽日 @ Sun Plaza", img: "https://images.unsplash.com/photo-1520529688591-b213eb5ee9a3?w=1000", events: [] },
                { date: "2/18", weekday: "WED", title: "小樽浪漫漫步", img: "https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=1000", events: [] },
                { date: "2/19", weekday: "THU", title: "札幌滑雪場之旅", img: "https://images.unsplash.com/photo-1454496522488-7a8e488e8606?w=1000", events: [] },
                { date: "2/20", weekday: "FRI", title: "頒獎典禮 @ Kitara", img: "https://images.unsplash.com/photo-1507838596357-01242f2105a9?w=1000", events: [] },
                { date: "2/21", weekday: "SAT", title: "網走冰河之夢", img: "https://images.unsplash.com/photo-1480497490787-505ec076689f?w=1000", events: [] },
                { date: "2/22", weekday: "SUN", title: "二条市場慶祝", img: "https://images.unsplash.com/photo-1534422298391-e4f8c172dddb?w=1000", events: [] }
            ],
            checklist: [{ task: "保暖暖暖包", done: false }, { task: "護照與參賽證", done: true }],
            links: [{ title: "JR 時刻查詢", url: "https://www.jrhokkaido.co.jp/" }],
            documents: []
        };

        let appData = JSON.parse(JSON.stringify(defaultData));

        function triggerInput(id) { document.getElementById(id).click(); }
        
        function openLightbox(src) {
            if (!src) return;
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

        // 核心圖片壓縮邏輯 (保留並優化性能)
        async function smartCompress(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const max = 800; // 手機端 800px 夠用了
                        if (w > max) { h = (h * max) / w; w = max; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.45)); // 0.45 壓縮率兼顧畫質與空間
                    };
                };
            });
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        
        function saveData() { 
            try {
                localStorage.setItem(STORE_KEY, JSON.stringify(appData));
            } catch (e) {
                alert("儲存空間已滿，請刪除部分文件後再試。");
            }
        }
        
        function loadData() { 
            const saved = localStorage.getItem(STORE_KEY); 
            if (saved) appData = JSON.parse(saved); 
        }

        // 文件上傳監聽
        document.getElementById('lib-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoading(true);
            const compressed = await smartCompress(file);
            appData.documents.push({ name: file.name.substring(0,12), data: compressed, date: new Date().toLocaleDateString() });
            saveData(); renderDocuments(); showLoading(false);
        });

        // 行程項目配圖監聽
        document.getElementById('event-img-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || activeEventIdx === null) return;
            showLoading(true);
            const compressed = await smartCompress(file);
            appData.itinerary[currentDayIdx].events[activeEventIdx].eventImg = compressed;
            saveData(); renderDay(currentDayIdx); showLoading(false);
        });

        // 封面配圖監聽
        document.getElementById('banner-img-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoading(true);
            const compressed = await smartCompress(file);
            appData.itinerary[currentDayIdx].img = compressed;
            saveData(); renderDay(currentDayIdx); showLoading(false);
        });

        function renderDocuments() {
            const container = document.getElementById('document-list'); 
            container.innerHTML = appData.documents.length ? '' : '<p class="text-xs text-white/20 text-center py-12 uppercase tracking-widest">沒有上傳的文件</p>';
            appData.documents.forEach((doc, i) => {
                container.innerHTML += `
                <div class="flex items-center gap-4 p-4 bg-white/5 rounded-3xl border border-white/5 animate-slide">
                    <div class="w-14 h-14 bg-white/10 rounded-2xl overflow-hidden shrink-0" onclick="openLightbox('${doc.data}')">
                        <img src="${doc.data}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0" onclick="openLightbox('${doc.data}')">
                        <h4 class="text-xs font-black text-white/90 truncate">${doc.name}</h4>
                        <p class="text-[9px] text-white/30 uppercase mt-1 tracking-widest">${doc.date}</p>
                    </div>
                    ${isEditing ? `<button onclick="appData.documents.splice(${i},1);saveData();renderDocuments();" class="text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>`;
            });
        }

        // 新增功能：地圖導航
        function openMap(location) {
            if (!location) return;
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
            window.open(url, '_blank');
        }

        function renderDay(idx) {
            currentDayIdx = idx;
            const day = appData.itinerary[idx];
            document.getElementById('day-img').src = day.img || '';
            document.getElementById('day-label').innerText = `DAY ${idx + 1} · FEB ${day.date.split('/')[1]}`;
            
            const titleCont = document.getElementById('day-title-container');
            titleCont.innerHTML = isEditing ? 
                `<input type="text" oninput="appData.itinerary[${idx}].title=this.value" value="${day.title}" class="w-full bg-white/20 border-b-2 border-white font-black text-2xl outline-none text-white p-1">` : 
                `<h2 class="text-2xl font-black text-white tracking-tight">${day.title}</h2>`;

            const totalCost = day.events.reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
            document.getElementById('day-budget').innerText = `¥ ${totalCost.toLocaleString()}`;

            const timeline = document.getElementById('timeline');
            timeline.innerHTML = `<div class="timeline-line"></div>`;
            
            day.events.forEach((ev, i) => {
                if (isEditing) {
                    timeline.innerHTML += `
                    <div class="relative pl-12 bg-gray-50 p-6 rounded-[2rem] border border-dashed border-gray-200 animate-slide">
                        <div class="flex gap-2 mb-3">
                            <input type="time" oninput="appData.itinerary[${idx}].events[${i}].timeFrom=this.value" value="${ev.timeFrom||''}" class="flex-1 text-[11px] p-2 bg-white rounded-xl border border-gray-200">
                            <input type="time" oninput="appData.itinerary[${idx}].events[${i}].timeTo=this.value" value="${ev.timeTo||''}" class="flex-1 text-[11px] p-2 bg-white rounded-xl border border-gray-200">
                            <input type="number" oninput="appData.itinerary[${idx}].events[${i}].cost=this.value" value="${ev.cost}" placeholder="¥" class="w-16 text-[11px] p-2 bg-white border border-gray-200 rounded-xl font-black">
                        </div>
                        <input type="text" oninput="appData.itinerary[${idx}].events[${i}].loc=this.value" value="${ev.loc}" placeholder="地點名稱" class="w-full text-sm font-black mb-2 p-2 bg-white border border-gray-200 rounded-xl">
                        <textarea oninput="appData.itinerary[${idx}].events[${i}].desc=this.value" class="w-full text-[11px] p-2 bg-white border border-gray-200 rounded-xl h-20" placeholder="內容細節">${ev.desc}</textarea>
                        <div class="flex gap-4 mt-4">
                            <button onclick="activeEventIdx=${i};triggerInput('event-img-input')" class="text-[10px] font-black text-blue-500 uppercase"><i class="fas fa-camera mr-1"></i> 上傳相片</button>
                            <button onclick="appData.itinerary[${idx}].events.splice(${i},1);renderDay(${idx})" class="text-[10px] font-black text-red-500 uppercase"><i class="fas fa-trash mr-1"></i> 刪除</button>
                        </div>
                    </div>`;
                } else {
                    timeline.innerHTML += `
                    <div class="relative pl-12 animate-slide">
                        <div class="timeline-dot"></div>
                        <div class="flex flex-col gap-1">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">${ev.timeFrom || '--:--'} ${ev.timeTo ? `→ ${ev.timeTo}` : ''}</p>
                            <div class="flex justify-between items-start gap-4">
                                <h3 onclick="openMap('${ev.loc}')" class="font-black text-lg text-[var(--jp-ink)] leading-tight active:text-[var(--jp-red)] cursor-pointer">${ev.loc}</h3>
                                <button onclick="openMap('${ev.loc}')" class="btn-tap shrink-0 w-10 h-10 bg-red-50 text-[var(--jp-red)] rounded-full flex items-center justify-center shadow-sm">
                                    <i class="fas fa-location-arrow text-xs"></i>
                                </button>
                            </div>
                            <div onclick="if('${ev.eventImg}') openLightbox('${ev.eventImg}')" class="mt-2">
                                <p class="text-xs text-gray-500 leading-relaxed">${ev.desc}</p>
                                <p class="text-[10px] font-black mt-2 text-gray-800">費用: ¥ ${(ev.cost || 0).toLocaleString()}</p>
                                ${ev.eventImg ? `<div class="event-img-container shadow-lg shadow-black/5"><img src="${ev.eventImg}" class="w-full h-full object-cover"></div>` : ''}
                            </div>
                        </div>
                    </div>`;
                }
            });
            document.querySelectorAll('.day-card').forEach((el, i) => el.classList.toggle('active', i === idx));
        }

        function renderChecklist() {
            const list = document.getElementById('checklist'); list.innerHTML = '';
            appData.checklist.forEach((item, i) => {
                list.innerHTML += `
                <div class="flex items-center gap-4 p-5 rounded-3xl bg-gray-50 border border-transparent animate-slide" onclick="${!isEditing ? `appData.checklist[${i}].done=!appData.checklist[${i}].done;saveData();renderChecklist()` : ''}">
                    <div class="w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all ${item.done ? 'bg-[var(--jp-red)] border-[var(--jp-red)] text-white shadow-lg shadow-red-200' : 'border-gray-200 bg-white'}">
                        ${item.done ? '<i class="fas fa-check text-[10px]"></i>' : ''}
                    </div>
                    <div class="flex-1">
                        ${isEditing ? `<input value="${item.task}" oninput="appData.checklist[${i}].task=this.value" class="w-full text-sm font-bold bg-transparent outline-none">` : `<span class="text-sm font-bold ${item.done ? 'line-through text-gray-300' : ''}">${item.task}</span>`}
                    </div>
                    ${isEditing ? `<button onclick="appData.checklist.splice(${i},1);renderChecklist()" class="text-red-300 p-2"><i class="fas fa-times-circle"></i></button>` : ''}
                </div>`;
            });
        }

        function renderLinks() {
            const list = document.getElementById('link-list'); list.innerHTML = '';
            appData.links.forEach((l, i) => {
                list.innerHTML += `
                <div class="flex gap-2">
                    <a href="${l.url}" target="_blank" class="flex-1 p-5 bg-blue-50/30 rounded-3xl text-sm font-bold flex justify-between items-center btn-tap">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-link text-blue-500 text-xs"></i>
                            ${isEditing ? `<input value="${l.title}" oninput="appData.links[${i}].title=this.value" class="bg-transparent outline-none font-bold" onclick="event.preventDefault()">` : `<span>${l.title}</span>`}
                        </div>
                        <i class="fas fa-chevron-right text-[10px] text-blue-200"></i>
                    </a>
                    ${isEditing ? `<button onclick="appData.links.splice(${i},1);renderLinks()" class="px-3 text-red-300"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>`;
            });
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const btn = document.getElementById('edit-btn');
            btn.innerHTML = isEditing ? '<i class="fas fa-check"></i> 儲存' : '<i class="fas fa-paint-brush"></i> 編輯';
            btn.classList.toggle('bg-green-600', isEditing); btn.classList.toggle('bg-[var(--jp-ink)]', !isEditing);
            ['add-event-container', 'banner-upload-btn', 'add-doc-btn', 'add-link-btn', 'add-check-btn'].forEach(id => document.getElementById(id).classList.toggle('hidden', !isEditing));
            if (!isEditing) saveData();
            renderDay(currentDayIdx); renderChecklist(); renderDocuments(); renderLinks();
        }

        function switchTab(tab) {
            document.getElementById('content-itinerary').classList.toggle('hidden', tab !== 'itinerary');
            document.getElementById('content-tools').classList.toggle('hidden', tab !== 'tools');
            
            const btnItin = document.getElementById('tab-itinerary');
            const btnTools = document.getElementById('tab-tools');
            
            if (tab === 'itinerary') {
                btnItin.classList.add('bg-[var(--jp-ink)]', 'text-white'); btnItin.classList.remove('text-gray-400');
                btnTools.classList.remove('bg-[var(--jp-ink)]', 'text-white'); btnTools.classList.add('text-gray-400');
            } else {
                btnTools.classList.add('bg-[var(--jp-ink)]', 'text-white'); btnTools.classList.remove('text-gray-400');
                btnItin.classList.remove('bg-[var(--jp-ink)]', 'text-white'); btnItin.classList.add('text-gray-400');
            }
        }

        function convertCurrency(type) { 
            const jpy = document.getElementById('jpy-input'), hkd = document.getElementById('hkd-input'); 
            if (type === 'jpy') hkd.value = (jpy.value * exchangeRate).toFixed(2); 
            else jpy.value = (hkd.value / exchangeRate).toFixed(0); 
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0667&longitude=141.35&current_weather=true');
                const data = await res.json();
                document.getElementById('weather-display').innerText = `${Math.round(data.current_weather.temperature)}°C 札幌`;
            } catch (e) { document.getElementById('weather-display').innerText = '-2°C 札幌'; }
        }

        function initDaySelector() {
            const s = document.getElementById('day-selector'); s.innerHTML = '';
            appData.itinerary.forEach((day, i) => {
                s.innerHTML += `
                <button onclick="renderDay(${i})" class="day-card btn-tap flex-shrink-0 w-16 h-24 rounded-[2rem] flex flex-col items-center justify-center bg-white border border-gray-100 transition-all">
                    <span class="text-[8px] font-black opacity-30 uppercase tracking-widest">FEB</span>
                    <span class="text-xl font-black">${day.date.split('/')[1]}</span>
                    <span class="text-[8px] font-bold opacity-30 mt-1">${day.weekday}</span>
                </button>`;
            });
        }

        function resetData() { if (confirm("確定重設所有數據？此操作無法恢復。")) { localStorage.removeItem(STORE_KEY); location.reload(); } }
        function addEvent() { appData.itinerary[currentDayIdx].events.push({ timeFrom: "09:00", loc: "新景點", desc: "請輸入細節", cost: 0, eventImg: "" }); renderDay(currentDayIdx); }
        function addCheckItem() { appData.checklist.push({ task: "新準備項目", done: false }); renderChecklist(); }
        function addLink() { appData.links.push({ title: "新網址連結", url: "https://" }); renderLinks(); }

        window.onload = () => { loadData(); initDaySelector(); renderDay(0); renderChecklist(); renderDocuments(); renderLinks(); fetchWeather(); };
    </script>
</body>
</html>
